<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ - Preguntas Frecuentes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="light-mode">
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="/"><h3 class="text-2xl font-bold">Tec-IA</h3></a>
                <button id="toggleTheme" class="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
            <div class="sidebar-menu">
                <form action="/analizar_texto">
                    <button type="submit" class="sidebar-button">
                        <i class="fa-solid fa-magnifying-glass"></i><span>Analizar texto</span>
                    </button>
                </form>
                <form action="/">
                    <button type="submit" class="sidebar-button">
                        <i class="fas fa-brain"></i>
                        <span>Chat Tec-IA</span>
                    </button>
                </form>
                <form action="/chatear_archivo">
                    <button type="submit" class="sidebar-button">
                        <i class="fas fa-file-alt" aria-hidden="true"></i>
                        <span>Chatear con PDF</span>
                    </button>
                </form>
                <form action="/chatear_modelo_llama">
                    <button type="submit" class="sidebar-button">
                        <i class="fas fa-comments"></i>
                        <span>Chatear con Llama3.2</span>
                    </button>
                </form>
                <form action="/listar_archivos">
                    <button type="submit" class="sidebar-button">
                        <i class="fas fa-folder-open"></i>
                        <span>Ver archivos</span>
                    </button>
                </form>
                <form action="/info_tec_ia">
                    <button type="submit" class="sidebar-button active">
                        <i class="fas fa-info-circle"></i>
                        <span>Sobre Tec-IA</span>
                    </button>
                </form>
            </div>
        </div>

        <div class="main-content-faq p-6 md:p-8 space-y-8">
            <header class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Preguntas Frecuentes (FAQ)</h1>
                    <p class="text-gray-500">Encuentra respuestas, busca por tema o ponte a prueba.</p>
                </div>
                 <button id="start-test-mode" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-vial"></i> Modo Test
                </button>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div>
                        <input type="text" id="search-input" placeholder="üîç Busca por palabras clave (ej. 'modelo de regresi√≥n')" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <div id="category-filters" class="flex flex-wrap gap-2 mt-4"></div>
                    </div>
                    <div id="faq-accordion-container" class="space-y-2"></div>
                    <div id="pagination-container" class="flex justify-between items-center mt-4"></div>
                </div>
                <div class="space-y-6">
                    <div class="ranking-container  p-4 rounded-lg shadow-md">
                        <h3 class="titulo-ranking">
                            <i class="fas fa-star text-yellow-500"></i> Preguntas m√°s vistas
                        </h3>
                        <div id="faq-ranking-list" class="space-y-2"></div>
                    </div>
                    <div id="test-mode-container" class="test-mode-bg p-4 rounded-lg hidden">
                        <h3 class="text-lg font-bold mb-3"><i class="fas fa-vial"></i> Modo Test Activo</h3>
                        <div id="test-question-area">
                            <p id="test-question" class="font-semibold text-lg"></p>
                            <p id="test-answer" class="mt-2 p-3 rounded hidden"></p>
                            <div class="flex gap-2 mt-4"><button id="show-answer-btn" class="flex-1 bg-gray-500 text-white py-2 px-3 rounded hover:bg-gray-600">Ver Respuesta</button></div>
                            <div class="flex gap-2 mt-2"><button id="correct-btn" class="flex-1 bg-green-500 text-white py-2 px-3 rounded hover:bg-green-600">‚úÖ Respond√≠ bien</button><button id="incorrect-btn" class="flex-1 bg-red-500 text-white py-2 px-3 rounded hover:bg-red-600">‚ùå No sab√≠a</button></div>
                        </div>
                        <div id="test-results-area" class="hidden">
                             <h4 class="font-bold text-xl mb-3">Resultados del Test</h4>
                             <div id="test-results-list" class="space-y-2"></div>
                             <button id="restart-test-btn" class="w-full mt-4 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Reiniciar Test</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias al DOM
            const searchInput = document.getElementById('search-input');
            const categoryFiltersContainer = document.getElementById('category-filters');
            const faqContainer = document.getElementById('faq-accordion-container');
            const rankingList = document.getElementById('faq-ranking-list');
            const paginationContainer = document.getElementById('pagination-container');
            // ... (resto de referencias al DOM sin cambios)
            const startTestBtn = document.getElementById('start-test-mode');
            const testModeContainer = document.getElementById('test-mode-container');
            const testQuestionArea = document.getElementById('test-question-area');
            const testQuestionEl = document.getElementById('test-question');
            const testAnswerEl = document.getElementById('test-answer');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const correctBtn = document.getElementById('correct-btn');
            const incorrectBtn = document.getElementById('incorrect-btn');
            const testResultsArea = document.getElementById('test-results-area');
            const testResultsList = document.getElementById('test-results-list');
            const restartTestBtn = document.getElementById('restart-test-btn');

            let allFaqs = [];
            let displayedFaqs = []; // FAQs despu√©s de aplicar filtros
            let currentPage = 1;
            const itemsPerPage = 10;

            let categories = [
                { id: 0, name: 'Institucional' },
                { id: 1, name: 'Programaci√≥n' },
                { id: 2, name: 'Ciencia de Datos' },
                { id: 3, name: 'IA' },
                { id: 4, name: 'Estad√≠stica' },
                { id: 5, name: 'Inteligencia del Negocio' },
            ];
            let testState = { active: false, questions: [], currentIndex: 0, results: [] };

            // **Funci√≥n para normalizar texto (ignorar acentos y puntuaci√≥n)**
            const normalizeText = (text) => {
                if (!text) return '';
                return text
                    .toLowerCase()
                    .normalize('NFD') // Descompone acentos: '√°' -> 'a' + '¬¥'
                    .replace(/[\u0300-\u036f]/g, '') // Elimina los diacr√≠ticos
                    .replace(/[¬ø¬°.,;]/g, ''); // Elimina signos de puntuaci√≥n comunes
            };
            
            const renderFaqs = () => {
                faqContainer.innerHTML = '';
                if (displayedFaqs.length === 0) {
                    faqContainer.innerHTML = `<p class="text-gray-500">No se encontraron preguntas. Intenta con otra b√∫squeda.</p>`;
                    renderPagination(); // Limpiar paginaci√≥n si no hay resultados
                    return;
                }

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedItems = displayedFaqs.slice(startIndex, endIndex);
                
                paginatedItems.forEach(faq => {
                    const faqElement = document.createElement('div');
                    faqElement.className = 'border border-gray-200 dark:border-gray-700 rounded-lg';
                    // **Contenido del acorde√≥n movido a un div interno para un colapso limpio**
                    faqElement.innerHTML = `
                        <button class="accordion-header w-full text-left p-4 font-semibold flex justify-between items-center">
                            <span>${faq.pregunta}</span>
                            <i class="fas fa-chevron-down transition-transform"></i>
                        </button>
                        <div class="accordion-content-faq">
                           <div class="p-4">
                                <p>${faq.respuesta}</p>
                                <div class="mt-2 text-xs text-gray-500">Categor√≠as: ${faq.categoria}</div>
                           </div>
                        </div>
                    `;
                    faqContainer.appendChild(faqElement);
                });
                renderPagination();
            };
            
            // **Nueva funci√≥n para renderizar la paginaci√≥n**
            const renderPagination = () => {
                paginationContainer.innerHTML = '';
                const totalPages = Math.ceil(displayedFaqs.length / itemsPerPage);

                if (totalPages <= 1) return; // No mostrar si hay 1 p√°gina o menos

                paginationContainer.innerHTML = `
                    <button id="prev-page-btn" class="pagination-btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">&laquo; Anterior</button>
                    <span class="text-gray-700 dark:text-gray-300">P√°gina ${currentPage} de ${totalPages}</span>
                    <button id="next-page-btn" class="pagination-btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Siguiente &raquo;</button>
                `;

                const prevBtn = document.getElementById('prev-page-btn');
                const nextBtn = document.getElementById('next-page-btn');

                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;

                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderFaqs();
                    }
                });

                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderFaqs();
                    }
                });
            };

            const renderRanking = async (allFaqsData) => {
                try {
                    const response = await fetch('/get_faq_ranking');
                    const rankingData = await response.json();
                    
                    const sortedIds = Object.keys(rankingData).sort((a, b) => rankingData[b] - rankingData[a]).slice(0, 5);
                    
                    rankingList.innerHTML = '';
                    sortedIds.forEach(id => {
                        const faq = allFaqsData.find(f => f.id == id);
                        if (faq) {
                            const li = document.createElement('a');
                            li.href = "#"; // Podr√≠a ser un enlace al ancla de la pregunta
                            li.className = 'block p-2 rounded hover:bg-gray-50 ';
                            li.textContent = faq.pregunta;
                            rankingList.appendChild(li);
                        }
                    });
                } catch (error) {
                    rankingList.innerHTML = `<p class="text-red-500 text-xs">No se pudo cargar el ranking.</p>`;
                    console.error('Error fetching ranking:', error);
                }
            };

            const renderCategoryFilters = () => {
                categoryFiltersContainer.innerHTML = `<button class="category-tag py-1 px-3 rounded-full border bg-indigo-600 text-white" data-category="all">Todas</button>`;
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'category-tag py-1 px-3 rounded-full border hover:bg-indigo-500 hover:text-white';
                    btn.dataset.category = cat.id;
                    btn.textContent = cat.name;
                    categoryFiltersContainer.appendChild(btn);
                });
            };

            const handleFilterAndSearch = () => {
                const searchTerm = normalizeText(searchInput.value);
                const activeBtnCategory = document.querySelector('.category-tag.active');
                const activeCategoryId = activeBtnCategory?.dataset.category || 'all';

                let filteredFaqs = allFaqs;
                if (activeCategoryId !== 'all') {
                    filteredFaqs = filteredFaqs.filter(faq => (faq.categoria === parseInt(activeCategoryId, 10)));
                }

                if (searchTerm) {
                    filteredFaqs = filteredFaqs.filter(faq => 
                        normalizeText(faq.pregunta).includes(searchTerm) || 
                        normalizeText(faq.respuesta).includes(searchTerm)
                    );
                }
                
                displayedFaqs = filteredFaqs;
                currentPage = 1; // **Resetear a la primera p√°gina con cada nueva b√∫squeda**
                renderFaqs();
            };

            // ==================================
            //         L√ìGICA DEL MODO TEST
            // ==================================

            const startTest = () => {
                testState.active = true;
                
                // **Filtro para excluir preguntas con ID < 99**
                const testableFaqs = allFaqs.filter(faq => parseInt(faq.id, 10) >= 99);
                
                // Si no hay preguntas para el test, muestra un mensaje y detiene la funci√≥n
                if (testableFaqs.length === 0) {
                    testModeContainer.classList.remove('hidden');
                    testQuestionArea.classList.add('hidden');
                    testResultsArea.classList.remove('hidden');
                    testResultsList.innerHTML = '<p>No hay preguntas disponibles para el modo test.</p>';
                    return;
                }
            
                testState.questions = [...testableFaqs].sort(() => 0.5 - Math.random());
                testState.currentIndex = 0;
                testState.results = [];

                testModeContainer.classList.remove('hidden');
                testQuestionArea.classList.remove('hidden');
                testResultsArea.classList.add('hidden');
            
                displayNextTestQuestion();
            };

            const displayNextTestQuestion = () => {

                // Verifica si quedan preguntas
                if (testState.currentIndex < 10) {
                    const currentQuestion = testState.questions[testState.currentIndex];
                    testQuestionEl.textContent = currentQuestion.pregunta;
                    testAnswerEl.innerHTML = currentQuestion.respuesta; // Usar innerHTML si la respuesta tiene formato
                    testAnswerEl.classList.add('hidden'); // Ocultar la respuesta al mostrar una nueva pregunta
                    showAnswerBtn.textContent = 'Ver Respuesta'; // Resetear texto del bot√≥n
                } else {
                    endTest(); // Si no hay m√°s preguntas, termina el test
                }
            };
            const endTest = () => {
                testState.active = false;
                testQuestionArea.classList.add('hidden');
                testResultsArea.classList.remove('hidden');
                testResultsList.innerHTML = ''; // Limpiar resultados anteriores

                // Calcular y mostrar el puntaje
                const correctAnswers = testState.results.filter(r => r.correct).length;
                const totalQuestions = 10;
                const score = totalQuestions > 0 ? (correctAnswers / totalQuestions) * 100 : 0;

                const summary = document.createElement('div');
                summary.innerHTML = `
                    <p class="font-bold text-lg">Test finalizado</p>
                    <p>Tu puntaje: <span class="font-bold text-2xl ${score >= 60 ? 'text-green-500' : 'text-red-500'}">${score.toFixed(0)}%</span> (${correctAnswers} de ${totalQuestions} correctas)</p>
                    <hr class="my-3">
                `;
                testResultsList.appendChild(summary);

                // Mostrar un resumen de las respuestas
                testState.results.forEach(result => {
                    const resultEl = document.createElement('div');
                    resultEl.className = 'p-2 rounded mb-2';
                    resultEl.innerHTML = `
                        <p class="font-semibold">${result.question}</p>
                        <p class="${result.correct ? 'text-green-500' : 'text-red-500'}">${result.correct ? '‚úÖ Respondiste bien' : '‚ùå No sab√≠as'}</p>
                    `;
                    testResultsList.appendChild(resultEl);
                });
            };
        
            const handleTestAnswer = (isCorrect) => {
                const currentQuestion = testState.questions[testState.currentIndex];
            
                // Guardar el resultado
                testState.results.push({
                    question: currentQuestion.pregunta,
                    correct: isCorrect
                });

                testState.currentIndex++; // Mover a la siguiente pregunta
                displayNextTestQuestion();
            };
            
            const init = async () => {
                try {
                    const response = await fetch('/get_faq');
                    allFaqs = await response.json();
                    displayedFaqs = [...allFaqs]; // Inicialmente mostrar todas
                    renderFaqs();
                    renderCategoryFilters();
                    await renderRanking(allFaqs);
                } catch (error) {
                    faqContainer.innerHTML = `<p class="text-red-500">Error al cargar las preguntas frecuentes.</p>`;
                }
            };
            
            searchInput.addEventListener('input', handleFilterAndSearch);
            categoryFiltersContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('.category-tag').forEach(btn => {
                        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                        // Restaurar estilo por defecto
                        if (!document.body.classList.contains('dark-mode')) {
                             btn.classList.add('hover:bg-indigo-500', 'hover:text-white');
                        }
                    });
                    e.target.classList.add('active', 'bg-indigo-600', 'text-white');
                    e.target.classList.remove('hover:bg-indigo-500', 'hover:text-white');
                    handleFilterAndSearch();
                }
            });

            // (El resto de los event listeners no necesitan cambios)
            faqContainer.addEventListener('click', (e) => {
                const header = e.target.closest('.accordion-header');
                if (header) {
                    header.classList.toggle('active');
                    header.querySelector('i').classList.toggle('rotate-180');
                }
            });
            startTestBtn.addEventListener('click', startTest);
            showAnswerBtn.addEventListener('click', () => {
                testAnswerEl.classList.toggle('hidden');
                // Cambia el texto del bot√≥n para que sea m√°s intuitivo
                if (testAnswerEl.classList.contains('hidden')) {
                    showAnswerBtn.textContent = 'Ver Respuesta';
                } else {
                    //testAnswerEl.classList.toggle('active');
                    showAnswerBtn.textContent = 'Ocultar Respuesta';
                }
            });
            correctBtn.addEventListener('click', () => handleTestAnswer(true));
            incorrectBtn.addEventListener('click', () => handleTestAnswer(false));
            restartTestBtn.addEventListener('click', startTest);

            init();
        });
    </script>
    <script src="{{ url_for('static',filename='js/theme.js') }}"></script>
</body>
</html>